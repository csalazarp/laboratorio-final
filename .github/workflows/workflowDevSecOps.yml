name: Node.js CI with SonarCloud Analysis

on:
  push:
    branches: [ revisiones ]

jobs:
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: SonarCloud Scan
        uses: sonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=devsecops-usach
            -Dsonar.projectKey=devsecops-usach_laboratorio-final
            -Dsonar.branch.name=revisiones

      - name: SonarQube Quality Gate
        id: quality-gate
        uses: sonarSource/sonarqube-quality-gate-action@revisiones
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
      - name: Revision de resultado de SonarQube
        if: steps.sonarqube-quality-gate-check.outputs.quality-gate-status != 'OK'
        run: |

          sudo apt-get install -y jq
          RESULTADO=$(curl -s -u ${SONAR_TOKEN}: \
            "https://sonarcloud.io/api/issues/search?componentKeys=devsecops-usach_laboratorio-final&resolved=false&type=VULNERABILITY&severities=MEDIUM,HIGH,BLOCKER")
          
          MEDIUM=$(echo $RESULTADO | jq '[.issues[] | select(.severity=="MEDIUM")] | length')
          HIGH=$(echo $RESULTADO | jq '[.issues[] | select(.severity=="HIGH")] | length')
          BLOCKER=$(echo $RESULTADO | jq '[.issues[] | select(.severity=="BLOCKER")] | length')

          NUM_VULNERABILIDADES=$RESULTADO | jq '.total'

          echo "Se encontraron vulnerabilidades en el código!!! "
          echo "Se detuvo la ejecución del pipeline"
          echo "$MEDIUM $HIGH $BLOCKER"
          echo "Total de vulnerabilidades: $NUM_VULNERABILIDADES"
          echo "$steps.sonarqube-quality-gate-check.outputs.quality-gate-status"
          exit 1