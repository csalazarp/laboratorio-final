name: Script DevSecOps USACH

on:
  push:
    branches: [ master ]

jobs:
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: SonarCloud Scan
        uses: sonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=devsecops-usach
            -Dsonar.projectKey=devsecops-usach_laboratorio-final
            -Dsonar.branch.name=master


      - name: Revision de resultado de SonarQube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          echo "Validando el estado del Quality Gate..."
          analysisId=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/ce/component?component=$REPO_NAME" | jq -r '.current.analysisId')

          echo "Analysis ID: $analysisId"

          qualityGateStatus=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/qualitygates/project_status?analysisId=$analysisId" | jq -r '.projectStatus.status')

          if [ "$qualityGateStatus" != "OK" ]; then
            echo "El proyecto no cumple con el Quality Gate: $qualityGateStatus."
            echo "Verificando vulnerabilidades críticas..."
            vulnerabilities=$(curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/issues/search?componentKeys=$REPO_NAME&resolved=false&type=VULNERABILITY&impactSeverities=MEDIUM,HIGH,BLOCKER" | jq  '.total')

            if [ "$vulnerabilities" -gt 0 ]; then
              echo "Se encontraron $vulnerabilities vulnerabilidades críticas. El proyecto no cumple con los estándares de seguridad."
              #exit 1
            fi
          else
            echo "El proyecto cumple con el Quality Gate y no tiene vulnerabilidades críticas. Continuando sin problemas."
          fi
                  if: steps.sonarqube-quality-gate-check.outputs.quality-gate-status != 'OK'
        # run: |

        #   echo "steps: $steps.sonarqube-quality-gate-check.outputs.quality-gate-status"
        #   sudo apt-get install -y jq
        #   RESULTADO=$(curl -s -u ${SONAR_TOKEN}: \
        #     "https://sonarcloud.io/api/issues/search?componentKeys=&resolved=false&type=VULNERABILITY&severities=MEDIUM,HIGH,BLOCKER")
          
        #   MEDIUM=$(echo $RESULTADO | jq '[.issues[] | select(.severity=="MEDIUM")] | length')
        #   HIGH=$(echo $RESULTADO | jq '[.issues[] | select(.severity=="HIGH")] | length')
        #   BLOCKER=$(echo $RESULTADO | jq '[.issues[] | select(.severity=="BLOCKER")] | length')

        #   NUM_VULNERABILIDADES=$RESULTADO | jq '.total'

        #   echo "Se encontraron vulnerabilidades en el código!!! "
        #   echo "Se detuvo la ejecución del pipeline"
        #   echo "$MEDIUM $HIGH $BLOCKER"
        #   echo "Total de vulnerabilidades: $NUM_VULNERABILIDADES"
        #   echo "$steps.sonarqube-quality-gate-check.outputs.quality-gate-status"
        #   exit 1